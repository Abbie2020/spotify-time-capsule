name: Update Spotify Playlist

on:
  schedule:
    # 08:00 UK local time year-round (handles GMT/BST by using two UTC hours)
    - cron: "0 8 * * *"    # 08:00 UTC (winter = 08:00 UK)
    - cron: "0 7 * * *"    # 07:00 UTC (summer = 08:00 UK)
  workflow_dispatch:        # allow manual runs from the UI

jobs:
  run:
    runs-on: ubuntu-latest

    # (Optional) Least-privilege token for checkout
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # Exchange refresh_token -> access_token for this run
      - name: Get Spotify access token
        id: token
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          BASIC=$(python - <<'PY'
import os, base64
print(base64.b64encode(f"{os.environ['CLIENT_ID']}:{os.environ['CLIENT_SECRET']}".encode()).decode())
PY
)
          RESP=$(curl -s -X POST https://accounts.spotify.com/api/token \
            -H "Authorization: Basic $BASIC" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&refresh_token=${REFRESH_TOKEN}")
          # pull access_token from JSON
          ACCESS=$(python - <<'PY'
import json,sys
print(json.load(sys.stdin)["access_token"])
PY
 <<<"$RESP")
          echo "access_token=$ACCESS" >> "$GITHUB_OUTPUT"

      - name: Run playlist updater
        env:
          # Your script can read this env var (recommended),
          # or you can keep using your Spotipy refresh flow locally-only.
          SPOTIFY_ACCESS_TOKEN: ${{ steps.token.outputs.access_token }}
        run: |
          python update_playlist.py --playlist-name "Daily Favourites" --uris-file tracks.txt
