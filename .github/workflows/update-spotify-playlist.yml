name: Update Spotify Playlist

on:
  schedule:
    # 08:00 UK local time year-round (handles GMT/BST by using two UTC hours)
    - cron: '0 8 * * *'    # 08:00 UTC (winter = 08:00 UK)
    - cron: '0 7 * * *'    # 07:00 UTC (summer = 08:00 UK)
  workflow_dispatch:        # allow manual runs from the UI

permissions:
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Get Spotify access token
        id: token
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          set -e  # Exit immediately if any command fails
          
          # Debug presence of secrets (values not printed)
          echo "Checking secrets..."
          [ -n "$SPOTIFY_CLIENT_ID" ] || { echo "Error: SPOTIFY_CLIENT_ID is empty" >&2; exit 1; }
          [ -n "$SPOTIFY_CLIENT_SECRET" ] || { echo "Error: SPOTIFY_CLIENT_SECRET is empty" >&2; exit 1; }
          [ -n "$SPOTIFY_REFRESH_TOKEN" ] || { echo "Error: SPOTIFY_REFRESH_TOKEN is empty" >&2; exit 1; }
          
          # Build Basic auth header with explicit base64 wrap
          echo "Building auth header..."
          BASIC=$(echo -n "$SPOTIFY_CLIENT_ID:$SPOTIFY_CLIENT_SECRET" | base64 -w 0)
          
          # Exchange refresh token for access token
          echo "Exchanging refresh token..."
          RESP=$(curl -sS -X POST "https://accounts.spotify.com/api/token" \
            -H "Authorization: Basic $BASIC" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=$SPOTIFY_REFRESH_TOKEN")
          
          # Parse response with proper error handling
          echo "Parsing response..."
          ACCESS=$(echo "$RESP" | python3 -c '
          import sys, json
          try:
              data = json.load(sys.stdin)
              token = data.get("access_token")
              if not token:
                  print("No access_token in response:", file=sys.stderr)
                  json.dump(data, sys.stderr, indent=2)
                  sys.exit(1)
              print(token)
          except Exception as e:
              print(f"Failed to parse response: {e}", file=sys.stderr)
              print(f"Raw response: {sys.stdin.read()}", file=sys.stderr)
              sys.exit(1)
                    ')
                    
          # Set output with success message
          echo "access_token=$ACCESS" >> "$GITHUB_OUTPUT"
          echo "Successfully obtained access token"

      - name: Run playlist updater
        env:
          # Action-provided short-lived access token (preferred)
          SPOTIFY_ACCESS_TOKEN: ${{ steps.token.outputs.access_token }}
        run: |
          # Fail fast if no access token was obtained
          if [ -z "$SPOTIFY_ACCESS_TOKEN" ]; then
            echo "ERROR: SPOTIFY_ACCESS_TOKEN is empty â€” aborting" >&2
            exit 1
          fi

          # Run your playlist creator script. It will prefer SPOTIFY_ACCESS_TOKEN if present.
          python spotify-time-capsule-playlist-creator.py
